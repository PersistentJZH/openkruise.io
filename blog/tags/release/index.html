<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenKruise RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenKruise Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="OpenKruise" href="/opensearch.xml"><title data-react-helmet="true">3 posts tagged with &quot;release&quot; | OpenKruise</title><meta data-react-helmet="true" property="og:title" content="3 posts tagged with &quot;release&quot; | OpenKruise"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://openkruise.io/blog/tags/release"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="icon" href="/img/openkruise.ico"><link data-react-helmet="true" rel="canonical" href="https://openkruise.io/blog/tags/release"><link data-react-helmet="true" rel="alternate" href="https://openkruise.io/blog/tags/release" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://openkruise.io/zh/blog/tags/release" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://openkruise.io/blog/tags/release" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/css/styles.0170f992.css">
<link rel="preload" href="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/js/runtime~main.cdb4d76d.js" as="script">
<link rel="preload" href="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/js/main.3ce8048c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">⭐️ If you like OpenKruise, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openkruise/kruise">GitHub</a>! ⭐️</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/img/openkruise.ico" alt="OpenKruise" class="themedImage_1VuW themedImage--light_3UqQ"><img src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/img/openkruise.ico" alt="OpenKruise" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">OpenKruise</b></a><a class="navbar__item navbar__link" href="/docs/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/">v1.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next</a></li><li><a class="dropdown__link" href="/docs/">v1.0</a></li><li><a class="dropdown__link" href="/docs/v0.10/">v0.10</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/release" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/zh/blog/tags/release" target="_self" rel="noopener noreferrer" class="dropdown__link">简体中文</a></li></ul></div><a href="https://github.com/openkruise/kruise" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Kl_"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/openkruise-1.0">OpenKruise v1.0, Reaching New Peaks of application automation</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/openkruise-0.10.0">OpenKruise 0.10.0, New features of multi-domain management, application protection</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/openkruise-0.9.0">OpenKruise 0.9.0, Supports Pod Restart and Deletion Protection</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/uniteddeployment">UnitedDeploymemt - Supporting Multi-domain Workload Management</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/learning-concurrent-reconciling">Learning Concurrent Reconciling</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;release&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/openkruise-1.0">OpenKruise v1.0, Reaching New Peaks of application automation</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-12-13T00:00:00.000Z" itemprop="datePublished">December 13, 2021</time> · <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/FillZpp.png" alt="Siyu Wang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Siyu Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenKruise</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>We’re pleased to announce the release of Kubernetes 1.0, which is a CNCF Sandbox level project.</p><p><a href="https://openkruise.io" target="_blank" rel="noopener noreferrer">OpenKruise</a> is an extended component suite for Kubernetes, which mainly focuses on application automations, such as deployment, upgrade, ops and avalibility protection. Mostly features provided by OpenKruise are built primarily based on CRD extensions. They can work in pure Kubernetes clusters without any other dependences.</p><p><img alt="openkruise-features|center|450x400" src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/images/features-en-659914e95b0df596a344f733aa198993.png"></p><p>Overall, OpenKruise currently provides features in these areas:</p><ul><li><strong>Application workloads</strong>: Enhanced strategies of deploy and upgrade for stateless/stateful/daemon applications, such as in-place update, canary/flowing upgrade.</li><li><strong>Sidecar container management</strong>: supports to define sidecar container alone, which means it can inject sidecar containers, upgrade them with no effect on application containers and even hot upgrade.</li><li><strong>Enhanced operations</strong>: such as restart containers in-place, pre-download images on specific nodes, keep containers launch priority in a Pod, distribute one resource to multiple namespaces.</li><li><strong>Application availability protection</strong>: protect avalibility for applications that deployed in Kubernetes.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="whats-new">What&#x27;s new?<a aria-hidden="true" class="hash-link" href="#whats-new" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="1-inplace-update-for-environments">1. InPlace Update for environments<a aria-hidden="true" class="hash-link" href="#1-inplace-update-for-environments" title="Direct link to heading">​</a></h3><p><em>Author: <a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer">@FillZpp</a></em></p><p>OpenKruise has supported <strong>InPlace Update</strong> since very early version, mostly for workloads like CloneSet and Advanced StatefulSet. Comparing to recreate Pods during upgrade, in-place update only has to modify the fields in existing Pods.</p><p><img alt="inplace-update-comparation|center|450x400" src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/images/inplace-update-comparation-fc948df195e332f578d4967c34b0c3d3.png"></p><p>As the picture shows above, we only modify the <code>image</code> field in Pod during in-place update. So that:</p><ul><li>Avoid additional cost of <em>scheduling</em>, <em>allocating IP</em>, <em>allocating and mounting volumes</em>.</li><li>Faster image pulling, because of we can re-use most of image layers pulled by the old image and only to pull several new layers.</li><li>When a container is in-place updating, the other containers in Pod will not be affected and remain running.</li></ul><p>However, OpenKruise only supports to in-place update <code>image</code> field in Pod and has to recreate Pods if other fields need to update. All the way through, more and more users hope OpenKruise could support in-place update more fields such as <code>env</code> -- which is hard to implement, for it is limited by kube-apiserver.</p><p>After our unremitting efforts, OpenKruise finally support in-place update environments via Downward API since version v1.0. Take the CloneSet YAML below as an example, user has to set the configuration in annotation and write a env from it. After that, he just needs to modify the annotation value when changing the configuration. Kruise will restart all containers with env from the annotation in such Pod to enable the new configuration.</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CloneSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;... the real env value ...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> APP_CONFIG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.annotations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;app-config&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">updateStrategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InPlaceIfPossible</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>At the same time, we have removed the limit of <code>imageID</code> for in-place update, which means you can update a new image with the same imageID to the old image.</em></p><p>For more details please read <a href="/docs/core-concepts/inplace-update">documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="2-distribute-resources-over-multiple-namespaces">2. Distribute resources over multiple namespaces<a aria-hidden="true" class="hash-link" href="#2-distribute-resources-over-multiple-namespaces" title="Direct link to heading">​</a></h3><p><em>Author: <a href="https://github.com/veophi" target="_blank" rel="noopener noreferrer">@veophi</a></em></p><p>For the scenario, where the namespace-scoped resources such as Secret and ConfigMap need to be distributed or synchronized to different namespaces, the native k8s currently only supports manual distribution and synchronization by users one-by-one, which is very inconvenient. </p><p>Typical examples: </p><ul><li>When users want to use the imagePullSecrets capability of SidecarSet, they must repeatedly create corresponding Secrets in relevant namespaces, and ensure the correctness and consistency of these Secret configurations;</li><li>When users want to configure some common environment variables, they probably need to distribute ConfigMaps to multiple namespaces, and the subsequent modifications of these ConfigMaps might require synchronization among these namespaces.</li></ul><p>Therefore, in the face of these scenarios that require the resource distribution and <strong>continuously synchronization across namespaces</strong>, we provide a tool, namely <strong>ResourceDistribution</strong>, to do this automatically. </p><p>Currently, ResourceDistribution supports the two kind resources --- <strong>Secret &amp; ConfigMap</strong>. </p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ResourceDistribution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> game</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespaceLabelSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># or includedNamespaces, excludedNamespaces</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So you can see ResourceDistribution is a kind of <strong>cluster-scoped CRD</strong>, which is mainly composed of two fields: <strong><code>resource</code> and <code>targets</code></strong>.</p><ul><li><code>resource</code> is a <strong>complete</strong> and <strong>correct</strong> resource structure in YAML style.</li><li><code>targets</code> indicates the target namespaces that the resource should be distributed into.</li></ul><p>For more details please read <a href="/docs/user-manuals/resourcedistribution">documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="3-container-launch-priority">3. Container launch priority<a aria-hidden="true" class="hash-link" href="#3-container-launch-priority" title="Direct link to heading">​</a></h3><p><em>Author: <a href="https://github.com/Concurrensee" target="_blank" rel="noopener noreferrer">@Concurrensee</a></em></p><p>Containers in a same Pod in it might have dependence, which means the application in one container runs depending on another container. For example:</p><ol><li>Container A has to start first. Container B can start only if A is already running.</li><li>Container B has to exit first. Container A can stop only if B has already exited.</li></ol><p>Currently, the sequences of containers start and stop are controlled by Kubelet.
Kubernetes used to have a KEP, which plans to add a type field for container to identify the priority of start and stop. However, it has been refused because of sig-node thought it may bring a huge change to code.</p><p>So OpenKruise provides a feature named <strong>Container Launch Priority</strong>, which helps user control the sequence of containers start in a Pod.</p><ol><li>User only has to put the annotation <code>apps.kruise.io/container-launch-priority: Ordered</code> in a Pod, then Kruise will ensure all containers in this Pod should be started by the sequence of <code>pod.spec.containers</code> list.</li><li>If you want to customize the launch sequence, you can add <code>KRUISE_CONTAINER_PRIORITY</code> environment in container. The range of the value is <code>[-2147483647, 2147483647]</code>. The container with higher priority will be guaranteed to start before the others with lower priority.</li></ol><p>For more details please read <a href="/docs/user-manuals/containerlaunchpriority">documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="4-kubectl-kruise-commandline-tool">4. <code>kubectl-kruise</code> commandline tool<a aria-hidden="true" class="hash-link" href="#4-kubectl-kruise-commandline-tool" title="Direct link to heading">​</a></h3><p><em>Author: <a href="https://github.com/hantmac" target="_blank" rel="noopener noreferrer">@hantmac</a></em></p><p>OpenKruise used to provide SDK like <code>kruise-api</code> and <code>client-java</code> for some programming languages, which can be imported into users&#x27; projects. On the other hand, some users also need to operate the workload resources with commandline in test environment.</p><p>However, the <code>rollout</code>, <code>set image</code> commands in original <code>kubectl</code> can only work for built-in workloads, such as Deployment and StatefulSet.</p><p>So, OpenKruise now provide a commandline tool named <code>kubectl-kruise</code>, which is a standard plugin of <code>kubectl</code> and can work for OpenKruise workload types.</p><div class="codeBlockContainer_K1bP language-bash"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># rollout undo cloneset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl kruise rollout undo cloneset/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  rollout status advanced statefulset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl kruise rollout status statefulsets.apps.kruise.io/sts-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set image of a cloneset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl kruise </span><span class="token builtin class-name">set</span><span class="token plain"> image cloneset/nginx </span><span class="token assign-left variable" style="color:#36acaa">busybox</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">busybox </span><span class="token assign-left variable" style="color:#36acaa">nginx</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nginx:1.9.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For more details please read <a href="/docs/cli-tool/kubectl-plugin">documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="5-other-changes">5. Other changes<a aria-hidden="true" class="hash-link" href="#5-other-changes" title="Direct link to heading">​</a></h3><p><strong>CloneSet:</strong></p><ul><li>Add <code>maxUnavailable</code> field in <code>scaleStrategy</code> to support rate limiting of scaling up.</li><li>Mark revision stable when all pods updated to it, won&#x27;t wait all pods to be ready.</li></ul><p><strong>WorkloadSpread:</strong></p><ul><li>Manage the pods that have created before WorkloadSpread.</li><li>Optimize the update and retry logic for webhook injection.</li></ul><p><strong>Advanced DaemonSet:</strong></p><ul><li>Support in-place update Daemon Pod.</li><li>Support progressive annotation to control if pods creation should be limited by partition.</li></ul><p><strong>SidecarSet:</strong></p><ul><li>Fix SidecarSet filter active pods.</li><li>Add <code>SourceContainerNameFrom</code> and <code>EnvNames</code> fields in <code>transferenv</code> to make the container name flexible and the list shorter.</li></ul><p><strong>PodUnavailableBudget:</strong></p><ul><li>Add no pub-protection annotation to skip validation for the specific Pod.</li><li>PodUnavailableBudget controller watches workload replicas changed.</li></ul><p><strong>NodeImage:</strong></p><ul><li>Add <code>--nodeimage-creation-delay</code> flag to delay NodeImage creation after Node ready.</li></ul><p><strong>UnitedDeployment:</strong></p><ul><li>Fix pod NodeSelectorTerms length 0 when UnitedDeployment NodeSelectorTerms is nil.</li></ul><p><strong>Other optimization:</strong></p><ul><li>kruise-daemon list and watch pods using protobuf.</li><li>Export cache resync args and defaults to be 0 in chart value.</li><li>Fix http checker reloading after webhook certs updated.</li><li>Generate CRDs with original controller-tools and markers.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="get-involved">Get Involved<a aria-hidden="true" class="hash-link" href="#get-involved" title="Direct link to heading">​</a></h2><p>Welcome to get involved with OpenKruise by joining us in Github/Slack/DingTalk/WeChat.
Have something you’d like to broadcast to our community?
Share your voice at our <a href="https://shimo.im/docs/gXqmeQOYBehZ4vqo" target="_blank" rel="noopener noreferrer">Bi-weekly community meeting (Chinese)</a>, or through the channels below:</p><ul><li>Join the community on <a href="https://kubernetes.slack.com/channels/openkruise" target="_blank" rel="noopener noreferrer">Slack</a> (English).</li><li>Join the community on DingTalk: Search GroupID <code>23330762</code> (Chinese).</li><li>Join the community on WeChat: Search User <code>openkruise</code> and let the robot invite you (Chinese).</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/release">release</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about OpenKruise v1.0, Reaching New Peaks of application automation" href="/blog/openkruise-1.0"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/openkruise-0.10.0">OpenKruise 0.10.0, New features of multi-domain management, application protection</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-06T00:00:00.000Z" itemprop="datePublished">September 6, 2021</time> · <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/FillZpp.png" alt="Siyu Wang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Siyu Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenKruise</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On Sep 6th, 2021, OpenKruise released the latest version v0.10.0, with new features, such as WorkloadSpread and PodUnavailableBudget. This article provides an overview of this new version.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="workloadspread">WorkloadSpread<a aria-hidden="true" class="hash-link" href="#workloadspread" title="Direct link to heading">​</a></h2><p>WorkloadSpread can distribute Pods of workload to different types of Node according to some polices, which empowers single workload the abilities for
multi-domain deployment and elastic deployment.</p><p>Some common policies include:</p><ul><li>fault toleration spread (for example, spread evenly among hosts, az, etc)</li><li>spread according to the specified ratio (for example, deploy Pod to several specified az according to the proportion)</li><li>subset management with priority, such as<ul><li>deploy Pods to ecs first, and then deploy to eci when its resources are insufficient.</li><li>deploy a fixed number of Pods to ecs first, and the rest Pods are deployed to eci.</li></ul></li><li>subset management with customization, such as<ul><li>control how many pods in a workload are deployed in different cpu arch</li><li>enable pods in different cpu arch to have different resource requirements</li></ul></li></ul><p>The feature of WorkloadSpread is similar with UnitedDeployment in OpenKruise community. Each WorkloadSpread defines multi-domain
called <code>subset</code>. Each domain may provide the limit to run the replicas number of pods called <code>maxReplicas</code>.
WorkloadSpread injects the domain configuration into the Pod by Webhook, and it also controls the order of scale in and scale out.</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WorkloadSpread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> workloadspread</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">targetRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1 </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> CloneSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> workload</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">subsets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> subset</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">requiredNodeSelectorTerm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matchExpressions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> topology.kubernetes.io/zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zone</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">maxReplicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10 </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> 30%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> subset</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">requiredNodeSelectorTerm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matchExpressions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> topology.kubernetes.io/zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zone</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The WorkloadSpread is related to a Workload via <code>targetRef</code>. When a Pod is created by the Workload, it will be injected topology policies by Kruise according to the rules in WorkloadSpread.</p><p>Note that WorkloadSpread uses <a href="https://kubernetes.io/docs/reference/labels-annotations-taints/#pod-deletion-cost" target="_blank" rel="noopener noreferrer">Pod Deletion Cost</a> to control the priority of scale down. So:</p><ul><li>If the Workload type is CloneSet, it already supports the feature.</li><li>If the Workload type is Deployment or ReplicaSet, it requires your Kubernetes version &gt;= 1.22.</li></ul><p>Also you have to enable <code>WorkloadSpread</code> feature-gate when you install or upgrade Kruise.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="podunavailablebudget">PodUnavailableBudget<a aria-hidden="true" class="hash-link" href="#podunavailablebudget" title="Direct link to heading">​</a></h2><p>Kubernetes offers <a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/" target="_blank" rel="noopener noreferrer">Pod Disruption Budget</a> to help you run highly available applications even when you introduce frequent <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/" target="_blank" rel="noopener noreferrer">voluntary disruptions</a>.
PDB limits the number of Pods of a replicated application that are down simultaneously from voluntary disruptions. However, it can only constrain the voluntary disruption triggered by the <a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/#eviction-api" target="_blank" rel="noopener noreferrer">Eviction API</a>.
For example, when you run kubectl drain, the tool tries to evict all of the Pods on the Node you&#x27;re taking out of service.</p><p>In the following voluntary disruption scenarios, there are still business disruption or SLA degradation situations:</p><ol><li>The application owner update deployment&#x27;s pod template for general upgrading, while cluster administrator drain nodes to scale the cluster down(learn about <a href="https://github.com/kubernetes/autoscaler/#readme" target="_blank" rel="noopener noreferrer">Cluster Autoscaling</a>).</li><li>The middleware team is using SidecarSet to rolling upgrade the sidecar containers of the cluster, e.g. ServiceMesh envoy, while HPA triggers the scale-down of business applications.</li><li>The application owner and middleware team release the same Pods at the same time based on OpenKruise cloneSet, sidecarSet in-place upgrades</li></ol><p>In voluntary disruption scenarios, PodUnavailableBudget can achieve the effect of preventing application disruption or SLA degradation, which greatly improves the high availability of application services.</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PodUnavailableBudget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">targetRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1 </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> CloneSet </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> StatefulSet </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># selector label query over pods managed by the budget</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># selector and TargetReference are mutually exclusive, targetRef is priority to take effect.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># selector is commonly used in scenarios where applications are deployed using multiple workloads,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># and targetRef is used for protection against a single workload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># selector:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#   matchLabels:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#     app: web-server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># maximum number of Pods unavailable for the current cloneset, the example is cloneset.replicas(5) * 60% = 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># maxUnavailable and minAvailable are mutually exclusive, maxUnavailable is priority to take effect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">maxUnavailable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 60%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Minimum number of Pods available for the current cloneset, the example is cloneset.replicas(5) * 40% = 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># minAvailable: 40%</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You have to enable the feature-gates when install or upgrade Kruise:</p><ul><li>PodUnavailableBudgetDeleteGate: protect Pod deletion or eviction.</li><li>PodUnavailableBudgetUpdateGate: protect Pod update operations, such as in-place update.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="cloneset-supports-scaledown-priority-by-spread-constraints">CloneSet supports scaledown priority by Spread Constraints<a aria-hidden="true" class="hash-link" href="#cloneset-supports-scaledown-priority-by-spread-constraints" title="Direct link to heading">​</a></h2><p>When <code>replicas</code> of a CloneSet decreased, it has the arithmetic to choose Pods and delete them.</p><ol><li>Node unassigned &lt; assigned</li><li>PodPending &lt; PodUnknown &lt; PodRunning</li><li>Not ready &lt; ready</li><li><strong>Lower pod-deletion cost &lt; higher pod-deletion-cost</strong></li><li><strong>Higher spread rank &lt; lower spread rank</strong></li><li>Been ready for empty time &lt; less time &lt; more time</li><li>Pods with containers with higher restart counts &lt; lower restart counts</li><li>Empty creation time pods &lt; newer pods &lt; older pods</li></ol><p>&quot;4&quot; has provided in Kruise v0.9.0 and it is also used by WorkloadSpread to control the Pod deletion. <strong>&quot;5&quot; is added in Kruise v0.10.0 to sort Pods by their Topology Spread Constraints during scaledown.</strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="advanced-statefulset-supports-scaleup-with-rate-limit">Advanced StatefulSet supports scaleup with rate limit<a aria-hidden="true" class="hash-link" href="#advanced-statefulset-supports-scaleup-with-rate-limit" title="Direct link to heading">​</a></h2><p>To avoid a large amount of failed Pods after user created an incorrect Advanced StatefulSet, Kruise add a <code>maxUnavailable</code> field into its <code>scaleStrategy</code>.</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scaleStrategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">maxUnavailable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10% </span><span class="token comment" style="color:#999988;font-style:italic"># percentage or absolute number</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the field is set, Advanced StatefulSet will guarantee that the number of unavailable Pods should not bigger than the strategy number during Pod creation.</p><p>Note that the feature can only be used in StatefulSet with <code>podManagementPolicy=Parallel</code>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="more">More<a aria-hidden="true" class="hash-link" href="#more" title="Direct link to heading">​</a></h2><p>For more changes, please refer to the <a href="https://github.com/openkruise/kruise/releases" target="_blank" rel="noopener noreferrer">release page</a> or <a href="https://github.com/openkruise/kruise/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer">ChangeLog</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/release">release</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about OpenKruise 0.10.0, New features of multi-domain management, application protection" href="/blog/openkruise-0.10.0"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/openkruise-0.9.0">OpenKruise 0.9.0, Supports Pod Restart and Deletion Protection</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-05-20T00:00:00.000Z" itemprop="datePublished">May 20, 2021</time> · <!-- -->13 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/FillZpp.png" alt="Siyu Wang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FillZpp" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Siyu Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of OpenKruise</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On May 20, 2021, OpenKruise released the latest version v0.9.0, with new features, such as Pod restart and resource cascading deletion protection. This article provides an overview of this new version.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="pod-restart-and-recreation">Pod Restart and Recreation<a aria-hidden="true" class="hash-link" href="#pod-restart-and-recreation" title="Direct link to heading">​</a></h2><p>Restarting container is a necessity in daily operation and a common technical method for recovery. In the native Kubernetes, the container granularity is inoperable. Pod, as the minimum operation unit, can only be created or deleted.</p><p>Some may ask: <em>why do users still need to pay attention to the operation such as container restart in the cloud-native era? Aren&#x27;t the services the only thing for users to focus on in the ideal Serverless model?</em></p><p>To answer this question, we need to see the differences between cloud-native architecture and traditional infrastructures. In the era of traditional physical and virtual machines, multiple application instances are deployed and run on one machine, but the lifecycles of the machine and applications are separated. Thus, application instance restart may only require a <code>systemctl</code> or <code>supervisor</code> command but not the restart of the entire machine. However, in the era of containers and cloud-native, the lifecycle of the application is bound to that of the Pod container. In other words, under normal circumstances, one container only runs one application process, and one Pod provides services for only one application instance.</p><p>Due to these restrictions, current native Kubernetes provides no API for the container (application) restart for upper-layer services. OpenKruise v0.9.0 supports restarting containers in a single Pod, compatible with standard Kubernetes clusters of version 1.16 or later. After installing or upgrading OpenKruise, users only need to create a <code>ContainerRecreateRequest</code> (CRR) object to initiate a restart process. The simplest YAML file is listed below:</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerRecreateRequest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">podName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sidecar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The value of namespace must be the same as the namespace of the Pod to be operated. The name can be set as needed. The <code>podName</code> in the spec clause indicates the Pod name. The containers indicate a list that specifies one or more container names in the Pod to restart.</p><p>In addition to the required fields above, CRR also provides a variety of optional restart policies:</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">failurePolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Fail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">orderedRecreate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">terminationGracePeriodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">unreadyGracePeriodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">minStartedSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">activeDeadlineSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ttlSecondsAfterFinished</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1800</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><code>failurePolicy</code>: Values: Fail or Ignore. Default value: Fail. If any container stops or fails to recreate, CRR ends immediately.</li><li><code>orderedRecreate</code>: Default value: false. Value true indicates when the list contains multiple containers, the new container will only be recreated after the previous recreation is finished.</li><li><code>terminationGracePeriodSeconds</code>: The time for the container to gracefully exit. If this parameter is not specified, the time defined for the Pod is used.</li><li><code>unreadyGracePeriodSeconds</code>: Set the Pod to the unready state before recreation and wait for the time expiration to execute recreation.<ul><li><code>Note</code>: This feature needs the feature-gate <code>KruisePodReadinessGate</code> to be enabled, which will inject a readinessGate when a Pod is created. Otherwise, only the pods created by the OpenKruise workload are injected with readinessGate by default. It means only these Pods can use the <code>unreadyGracePeriodSeconds</code> parameter during the CRR recreation.</li></ul></li><li><code>minStartedSeconds</code>: The minimal period that the new container remains running to judge whether the container is recreated successfully.</li><li><code>activeDeadlineSeconds</code>: The expiration period set for CRR execution to mark as ended (unfinished container will be marked as failed.)</li><li><code>ttlSecondsAfterFinished</code>: The period after which the CRR will be deleted automatically after the execution ends.</li></ul><p><strong>How it works under the hood:</strong> After it is created, a CRR is processed by the kruise-manager. Then, it will be sent to the kruise-daemon (contained by the node where Pod resides) for execution. The execution process is listed below:</p><ol><li>If <code>preStop</code> is specified for a Pod, the kruise-daemon will first call the CRI to run the command specified by <code>preStop</code> in the container.</li><li>If no <code>preStop</code> exists or <code>preStop</code> execution is completed, the kruise-daemon will call the CRI to stop the container.</li><li>When the kubelet detects the container exiting, it creates a new container with an increasing &quot;serial number&quot; and starts it. <code>postStart</code> will be executed at the same time.</li><li>When the kruise-daemon detects the start of the new container, it reports to CRR that the restart is completed.</li></ol><p><img alt="ContainerRecreateRequest" src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/images/containerrecreaterequest-f690e891609591c68e231c23212204ca.png"></p><p>The container &quot;serial number&quot; corresponds to the <code>restartCount</code> reported by kubelet in the Pod status. Therefore, the <code>restartCount</code> of the Pod increases after the container is restarted. Temporary files written to the <code>rootfs</code> in the old container will be lost due to the container recreation, but data in the volume mount remains.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="cascading-deletion-protection">Cascading Deletion Protection<a aria-hidden="true" class="hash-link" href="#cascading-deletion-protection" title="Direct link to heading">​</a></h2><p>The level triggered automation of Kubernetes is a double-edged sword. It brings declarative deployment capabilities to applications while potentially enlarging the influence of mistakes at a final-state scale. For example, with the cascading deletion mechanism, once an owning resource is deleted under normal circumstances (non-orphan deletion), all owned resources associated will be deleted by the following rules:</p><ol><li>If a CRD is deleted, all its corresponding CR will be cleared.</li><li>If a namespace is deleted, all resources in this namespace, including Pods, will be cleared.</li><li>If a workload (Deployment, StatefulSet, etc) is deleted, all Pods under it will be cleared.</li></ol><p>Due to failures caused by cascading deletion, we have heard many complaints from Kubernetes users and developers in the community. It is unbearable for any enterprise to mistakenly delete objects at such a large scale in the production environment.</p><p>Therefore, in OpenKruise v0.9.0, we applied the feature of cascading deletion protection to community in the hope of ensuring stability for more users. If you want to use this feature in the current version, the feature-gate of <code>ResourcesDeletionProtection</code> needs to be explicitly enabled when installing or upgrading OpenKruise.</p><p>A label of <code>policy.kruise.io/delete-protection</code> can be given on the resource objects that require protection. Its value can be the following two things:</p><ul><li><strong>Always</strong>: The object cannot be deleted unless the label is removed.</li><li><strong>Cascading</strong>: The object cannot be deleted if any subordinate resources are available.</li></ul><p>The following table lists the supported resource types and cascading relationships:</p><table><thead><tr><th>Kind</th><th>Group</th><th>Version</th><th><strong>Cascading</strong> judgement</th></tr></thead><tbody><tr><td><code>Namespace</code></td><td>core</td><td>v1</td><td>whether there is active Pods in this namespace</td></tr><tr><td><code>CustomResourceDefinition</code></td><td>apiextensions.k8s.io</td><td>v1beta1, v1</td><td>whether there is existing CRs of this CRD</td></tr><tr><td><code>Deployment</code></td><td>apps</td><td>v1</td><td>whether the replicas is 0</td></tr><tr><td><code>StatefulSet</code></td><td>apps</td><td>v1</td><td>whether the replicas is 0</td></tr><tr><td><code>ReplicaSet</code></td><td>apps</td><td>v1</td><td>whether the replicas is 0</td></tr><tr><td><code>CloneSet</code></td><td>apps.kruise.io</td><td>v1alpha1</td><td>whether the replicas is 0</td></tr><tr><td><code>StatefulSet</code></td><td>apps.kruise.io</td><td>v1alpha1, v1beta1</td><td>whether the replicas is 0</td></tr><tr><td><code>UnitedDeployment</code></td><td>apps.kruise.io</td><td>v1alpha1</td><td>whether the replicas is 0</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_31ik" id="new-features-of-cloneset">New Features of CloneSet<a aria-hidden="true" class="hash-link" href="#new-features-of-cloneset" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="deletion-priority">Deletion Priority<a aria-hidden="true" class="hash-link" href="#deletion-priority" title="Direct link to heading">​</a></h3><p>The <code>controller.kubernetes.io/pod-deletion-cost</code> annotation was added to Kubernetes after version 1.21. <code>ReplicaSet</code> will sort the Kubernetes resources according to this cost value during scale in. CloneSet has supported the same feature since OpenKruise v0.9.0.</p><p>Users can configure this annotation in the pod. The int type of its value indicates the deletion cost of a certain pod compared to other pods under the same CloneSet. Pods with a lower cost have a higher deletion priority. If this annotation is not set, the deletion cost of the pod is 0 by default.</p><p><em>Note</em>: This deletion order is not determined solely by deletion cost. The real order serves like this:</p><ol><li>Not scheduled &lt; scheduled</li><li>PodPending &lt; PodUnknown &lt; PodRunning</li><li>Not ready &lt; ready</li><li><strong>Smaller pod-deletion cost &lt; larger pod-deletion cost</strong></li><li>Period in the Ready state: short &lt; long</li><li>Containers restart: more times &lt; fewer times</li><li>Creation time: short &lt; long</li></ol><h3 class="anchor anchorWithStickyNavbar_31ik" id="image-pre-download-for-in-place-update">Image Pre-Download for In-Place Update<a aria-hidden="true" class="hash-link" href="#image-pre-download-for-in-place-update" title="Direct link to heading">​</a></h3><p>When CloneSet is used for the in-place update of an application, only the container image is updated, while the Pod is not rebuilt. This ensures that the node where the Pod is located will not change. Therefore, if the CloneSet pulls the new image from all the Pod nodes in advance, the Pod in-place update speed will be improved substantially in subsequent batch releases.</p><p>If you want to use this feature in the current version, the feature-gate of <code>PreDownloadImageForInPlaceUpdate</code> needs to be explicitly enabled when installing or upgrading OpenKruise. If you update the images in the CloneSet template and the publish policy supports in-place update, CloneSet will create an <code>ImagePullJob</code> object automatically (the batch image pre-download function provided by OpenKruise) to download new images in advance on the node where the Pod is located.</p><p>By default, CloneSet sets the parallelism to 1 for <code>ImagePullJob</code>, which means images are pulled for one node and then another. For any adjustment, you can set the parallelism in the CloneSet annotation by executing the following code:</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CloneSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">apps.kruise.io/image-predownload-parallelism</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="pod-replacement-by-scale-out-and-scale-in">Pod Replacement by Scale Out and Scale In<a aria-hidden="true" class="hash-link" href="#pod-replacement-by-scale-out-and-scale-in" title="Direct link to heading">​</a></h3><p>In previous versions, the <code>maxUnavailable</code> and <code>maxSurge</code> policies of CloneSet only take effect during the application release process. In OpenKruise v0.9.0 and later versions, these two policies also function when deleting a specified Pod.</p><p>When the user specifies one or more Pods to be deleted through <code>podsToDelete</code> or <code>apps.kruise.io/specified-delete</code>: true, CloneSet will only execute deletion when the number of unavailable Pods (of the total replicas) is less than the value of <code>maxUnavailable</code>. In addition, if the user has configured the <code>maxSurge</code> policy, the CloneSet will possibly create a new Pod first, wait for the new Pod to be ready, and then delete the old specified Pod.</p><p>The replacement method depends on the value of maxUnavailable and the number of unavailable Pods. For example:</p><ul><li>For a CloneSet, <code>maxUnavailable=2, maxSurge=1</code> and only <code>pod-a</code> is unavailable. If you specify <code>pod-b</code> to be deleted, CloneSet will delete it promptly and create a new Pod.</li><li>For a CloneSet, <code>maxUnavailable=1, maxSurge=1</code> and only <code>pod-a</code> is unavailable. If you specify <code>pod-b</code> to be deleted, CloneSet will create a new Pod, wait for it to be ready, and then delete the pod-b.</li><li>For a CloneSet, <code>maxUnavailable=1, maxSurge=1</code> and only <code>pod-a</code> is unavailable. If you specify this <code>pod-a</code> to be deleted, CloneSet will delete it promptly and create a new Pod.</li></ul><h3 class="anchor anchorWithStickyNavbar_31ik" id="efficient-rollback-based-on-partition-final-state">Efficient Rollback Based on Partition Final State<a aria-hidden="true" class="hash-link" href="#efficient-rollback-based-on-partition-final-state" title="Direct link to heading">​</a></h3><p>In the native workload, Deployment does not support phased release, while StatefulSet provides partition semantics to allow users to control the times of gray scale upgrades. OpenKruise workloads, such as CloneSet and Advanced StatefulSet, also provide partitions to support phased release.</p><p>For CloneSet, the semantics of Partition is <strong>the number or percentage of Pods remaining in the old version</strong>. For example, for a CloneSet with 100 replicas, if the partition value is changed in the sequence of 80 ➡️ 60 ➡️ 40 ➡️ 20 ➡️ 0 by steps during the image upgrade, the CloneSet is released in five batches.</p><p>However, in the past, whether it is Deployment, StatefulSet, or CloneSet, if rollback is required during the release process, the template information (image) must be changed back to the old version. During the phased release of StatefulSet and CloneSet, reducing partition value will trigger the upgrade to a new version. Increasing partition value will not trigger rollback to the old version.</p><p>The partition of CloneSet supports the &quot;final state rollback&quot; function after v0.9.0. If the feature-gate <code>CloneSetPartitionRollback</code> is enabled when installing or upgrading OpenKruise, increasing the partition value will trigger CloneSet to roll back the corresponding number of new Pods to the old version.</p><p>There is a clear advantage here. During the phased release, only the partition value needs to be adjusted to flexibly control the numbers of old and new versions. However, the &quot;old and new versions&quot; for CloneSet correspond to <code>updateRevision</code> and <code>currentRevision</code> in its status:</p><ul><li>updateRevision: The version of the template defined by the current CloneSet.</li><li>currentRevision: The template version of CloneSet during the <strong>previous successful full release</strong>.</li></ul><h3 class="anchor anchorWithStickyNavbar_31ik" id="short-hash">Short Hash<a aria-hidden="true" class="hash-link" href="#short-hash" title="Direct link to heading">​</a></h3><p>By default, the value of <code>controller-revision-hash</code> in Pod label set by CloneSet is the full name of the <code>ControllerRevision</code>. For example:</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">controller-revision-hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cloneset</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">956df7994</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The name is concatenated with the CloneSet name and the <code>ControllerRevision</code> hash value. Generally, the hash value is 8 to 10 characters in length. In Kubernetes, a label cannot exceed 63 characters in length. Therefore, the name of CloneSet cannot exceed 52 characters in length, or the Pod cannot be created.</p><p>In v0.9.0, the new feature-gate <code>CloneSetShortHash</code> is introduced. If it is enabled, CloneSet will set the value of <code>controller-revision-hash</code> in the Pod to a hash value only, like 956df7994. Therefore, the length restriction of the CloneSet name is eliminated. (CloneSet can still recognize and manage the Pod with revision labels in the full format, even if this function is enabled.)</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="new-features-of-sidecarset">New Features of SidecarSet<a aria-hidden="true" class="hash-link" href="#new-features-of-sidecarset" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="sidecar-hot-upgrade-function">Sidecar Hot Upgrade Function<a aria-hidden="true" class="hash-link" href="#sidecar-hot-upgrade-function" title="Direct link to heading">​</a></h3><p>SidecarSet is a workload provided by OpenKruise to manage sidecar containers separately. Users can inject and upgrade specified sidecar containers within a certain range of Pods using <code>SidecarSet</code>.</p><p>By default, for the independent in-place sidecar upgrade, the sidecar stops the container of the old version first and then creates a container of the new version. This method applies to sidecar containers that do not affect the Pod service availability, such as the log collection agent. However, for sidecar containers acting as a proxy such as Istio Envoy, this upgrade method is defective. Envoy, as a proxy container in the Pod, handles all the traffic. If users restart and upgrade directly, service availability will be affected. Thus, you need a complex grace termination and coordination mechanism to upgrade the envoy sidecar separately. Therefore, we offer a new solution for the upgrade of this kind of sidecar containers, namely, hot upgrade:</p><div class="codeBlockContainer_K1bP language-yaml"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps.kruise.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SidecarSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">sidecar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">lifecycle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">postStart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">exec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /usr/local/bin/nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent migrate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">upgradeStrategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">upgradeType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HotUpgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hotUpgradeEmptyImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> empty</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.0.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><code>upgradeType</code>: <code>HotUpgrade</code> indicates that the type of the sidecar container is a hot upgrade, so the hot upgrade solution, <code>hotUpgradeEmptyImage</code>, will be executed. When performing a hot upgrade on the sidecar container, an empty container is required to switch services during the upgrade. The empty container has almost the same configuration as the sidecar container, except the image address, for example, command, lifecycle, and probe, but it does no actual work.</li><li><code>lifecycle.postStart</code>: State migration. This procedure completes the state migration during the hot upgrade. The script needs to be executed according to business characteristics. For example, NGINX hot upgrade requires shared Listen FD and traffic reloading.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="more">More<a aria-hidden="true" class="hash-link" href="#more" title="Direct link to heading">​</a></h2><p>For more changes, please refer to the <a href="https://github.com/openkruise/kruise/releases" target="_blank" rel="noopener noreferrer">release page</a> or <a href="https://github.com/openkruise/kruise/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer">ChangeLog</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/release">release</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about OpenKruise 0.9.0, Supports Pod Restart and Deletion Protection" href="/blog/openkruise-0.9.0"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://kubernetes.slack.com/channels/openkruise" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Kubernetes Slack ( #openkruise channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.dingtalk.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>DingTalk (Group ID: 23330762 )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://shimo.im/docs/gXqmeQOYBehZ4vqo" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/openkruise/kruise" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/openkruise/community/blob/master/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© 2021 The OpenKruise Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
<script src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/js/runtime~main.cdb4d76d.js"></script>
<script src="https://cdn.jsdelivr.net/gh/openkruise/openkruise.io@gh-pages/assets/js/main.3ce8048c.js"></script>
</body>
</html>