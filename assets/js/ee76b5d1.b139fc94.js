"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[1274],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return d}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(a),d=r,g=p["".concat(l,".").concat(d)]||p[d]||m[d]||i;return a?n.createElement(g,o(o({ref:t},u),{},{components:a})):n.createElement(g,o({ref:t},u))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},7035:function(e,t,a){a.r(t),a.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return m}});var n=a(7462),r=a(3366),i=(a(7294),a(3905)),o=["components"],s={},l="AutoScale",c={unversionedId:"user-manuals/autoscale",id:"user-manuals/autoscale",title:"AutoScale",description:"Feature overview",source:"@site/kruisegame/user-manuals/autoscale.md",sourceDirName:"user-manuals",slug:"/user-manuals/autoscale",permalink:"/kruisegame/user-manuals/autoscale",draft:!1,tags:[],version:"current",lastUpdatedBy:"skkkkkkk",lastUpdatedAt:1685069311,formattedLastUpdatedAt:"5/26/2023",frontMatter:{},sidebar:"kruisegame",previous:{title:"Network",permalink:"/kruisegame/user-manuals/network"},next:{title:"GameServer Monitor",permalink:"/kruisegame/user-manuals/gameserver-monitor"}},u={},m=[{value:"Feature overview",id:"feature-overview",level:2},{value:"Usage Example",id:"usage-example",level:2}],p={toc:m};function d(e){var t=e.components,s=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},p,s,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"autoscale"},"AutoScale"),(0,i.kt)("h2",{id:"feature-overview"},"Feature overview"),(0,i.kt)("p",null,"Compared to stateless service types, game servers have higher requirements for automatic scaling, especially in terms of scaling down."),(0,i.kt)("p",null,"The differences between game servers become more and more obvious over time, and the precision requirements for scaling down are extremely high. Coarse-grained scaling mechanisms can easily cause negative effects such as player disconnections, resulting in huge losses for the business."),(0,i.kt)("p",null,"The horizontal scaling mechanism in native Kubernetes is shown in the following figure:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"autoscaling-k8s-en.png",src:a(2579).Z,width:"1414",height:"876"})),(0,i.kt)("p",null,"In the game scenario, its main problems are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"At the pod level, it is unable to perceive the game server game status and therefore cannot set deletion priority based on game status."),(0,i.kt)("li",{parentName:"ul"},"At the workload level, it cannot select scaling-down objects based on game status."),(0,i.kt)("li",{parentName:"ul"},"At the autoscaler level, it cannot accurately calculate the appropriate number of replicas based on the game server game status.")),(0,i.kt)("p",null,"In this way, the automatic scaling mechanism based on native Kubernetes will cause two major problems in the game scenario:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The number of scaling down is not accurate. It is easy to delete too many or too few game servers."),(0,i.kt)("li",{parentName:"ul"},"The scaling-down object is not accurate. It is easy to delete game servers with high game load levels.")),(0,i.kt)("p",null,"The automatic scaling mechanism of OKG is shown in the following figure:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"autoscaling-okg-en.png",src:a(5714).Z,width:"1944",height:"1054"})),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"At the game server level, each game server can report its own status and expose whether it is in the WaitToBeDeleted state through custom service quality or external components."),(0,i.kt)("li",{parentName:"ul"},"At the workload level, the GameServerSet can determine the scaling-down object based on the business status reported by the game server. As described in ",(0,i.kt)("a",{parentName:"li",href:"/kruisegame/user-manuals/gameservers-scale"},"Game Server Horizontal Scaling"),", the game server in the WaitToBeDeleted state is the highest priority game server to be deleted during scaling down."),(0,i.kt)("li",{parentName:"ul"},"At the autoscaler level, accurately calculate the number of game servers in the WaitToBeDeleted state, and use it as the scaling-down quantity to avoid accidental deletion.")),(0,i.kt)("p",null,"In this way, OKG's automatic scaler will only delete game servers in the WaitToBeDeleted state during the scaling-down window, achieving targeted and precise scaling down."),(0,i.kt)("h2",{id:"usage-example"},"Usage Example"),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},(0,i.kt)("strong",{parentName:"em"},"Prerequisites: Install ",(0,i.kt)("a",{parentName:"strong",href:"https://keda.sh/docs/2.10/deploy/"},"KEDA")," in the cluster."))),(0,i.kt)("p",null,"Deploy the ScaledObject object to set the automatic scaling strategy. Refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/kedacore/keda/blob/main/apis/keda/v1alpha1/scaledobject_types.go"},"ScaledObject API")," for the specific field meanings."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: keda.sh/v1alpha1\nkind: ScaledObject\nmetadata:\n  name: minecraft # Fill in the name of the corresponding GameServerSet\nspec:\n  scaleTargetRef:\n    name: minecraft # Fill in the name of the corresponding GameServerSet\n    apiVersion: game.kruise.io/v1alpha1 \n    kind: GameServerSet\n  pollingInterval: 30\n  minReplicaCount: 0\n  advanced:\n    horizontalPodAutoscalerConfig: \n      behavior: # Inherit from HPA behavior, refer to https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/#configurable-scaling-behavior\n        scaleDown:\n          stabilizationWindowSeconds: 45 # Set the scaling-down stabilization window time to 45 seconds\n          policies:\n            - type: Percent\n              value: 100\n              periodSeconds: 15\n  triggers:\n    - type: external\n      metricType: Value\n      metadata:\n        scalerAddress: kruise-game-external-scaler.kruise-game-system:6000\n\n")),(0,i.kt)("p",null,"After deployment, change the opsState of the gs minecraft-0 to WaitToBeDeleted (see ",(0,i.kt)("a",{parentName:"p",href:"/kruisegame/user-manuals/service-qualities"},"Custom Service Quality")," for automated setting of game server status)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl edit gs minecraft-0\n\n...\nspec:\n  deletionPriority: 0 \n  opsState: WaitToBeDeleted # Set to None initially, and change it to WaitToBeDeleted\n  updatePriority: 0\n...\n\n")),(0,i.kt)("p",null,"After the scaling-down window period, the game server minecraft-0 is automatically deleted."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get gs\nNAME          STATE      OPSSTATE          DP    UP\nminecraft-0   Deleting   WaitToBeDeleted   0     0\nminecraft-1   Ready      None              0     0\nminecraft-2   Ready      None              0     0\n\n# After a while\n...\n\nkubectl get gs\nNAME          STATE   OPSSTATE   DP    UP\nminecraft-1   Ready   None       0     0\nminecraft-2   Ready   None       0     0\n\n")))}d.isMDXComponent=!0},2579:function(e,t,a){t.Z=a.p+"assets/images/autoscaling-k8s-en-4d7f2d592f92c8846f1d3f6440d72ac5.png"},5714:function(e,t,a){t.Z=a.p+"assets/images/autoscaling-okg-en-c3cb7a80d8eab95350d5cab61c39cc9f.png"}}]);