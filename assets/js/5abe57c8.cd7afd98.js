"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[9536],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return m}});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),u=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=u(e.components);return r.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(t),m=a,f=d["".concat(s,".").concat(m)]||d[m]||c[m]||o;return t?r.createElement(f,i(i({ref:n},p),{},{components:t})):r.createElement(f,i({ref:n},p))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,i=new Array(o);i[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=t[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},2517:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return c}});var r=t(7462),a=t(3366),o=(t(7294),t(3905)),i=["components"],l={title:"Container Launch Priority"},s=void 0,u={unversionedId:"user-manuals/containerlaunchpriority",id:"version-v1.4/user-manuals/containerlaunchpriority",title:"Container Launch Priority",description:"FEATURE STATE: Kruise v1.0.0",source:"@site/versioned_docs/version-v1.4/user-manuals/containerlaunchpriority.md",sourceDirName:"user-manuals",slug:"/user-manuals/containerlaunchpriority",permalink:"/docs/v1.4/user-manuals/containerlaunchpriority",draft:!1,editUrl:"https://github.com/openkruise/openkruise.io/edit/master/docs/user-manuals/containerlaunchpriority.md",tags:[],version:"v1.4",lastUpdatedBy:"berg",lastUpdatedAt:1680507223,formattedLastUpdatedAt:"4/3/2023",frontMatter:{title:"Container Launch Priority"},sidebar:"docs",previous:{title:"Job Sidecar Terminator",permalink:"/docs/v1.4/user-manuals/jobsidecarterminator"},next:{title:"WorkloadSpread",permalink:"/docs/v1.4/user-manuals/workloadspread"}},p={},c=[{value:"Usage",id:"usage",level:2},{value:"Start by containers ordinal",id:"start-by-containers-ordinal",level:3},{value:"Start by configurable sequence",id:"start-by-configurable-sequence",level:3},{value:"Requirement",id:"requirement",level:2},{value:"Implementation Details",id:"implementation-details",level:2}],d={toc:c};function m(e){var n=e.components,t=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"FEATURE STATE:")," Kruise v1.0.0"),(0,o.kt)("p",null,"Container Launch Priority provides a way to help users ",(0,o.kt)("strong",{parentName:"p"},"control the sequence of containers start")," in a Pod."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Usually the sequences of containers start and stop are controlled by Kubelet. Kubernetes used to have a ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/753-sidecar-containers"},"KEP"),", which plans to add a type field for container to identify the priority of start and stop.\nHowever, it has been refused because of ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/enhancements/issues/753#issuecomment-713471597"},"sig-node thought it may bring a huge change to code"),".")),(0,o.kt)("p",null,"Note that the feature works for Pod, ",(0,o.kt)("strong",{parentName:"p"},"no matter what kind of owner it belongs to"),", which means Deployment, CloneSet or any other Workloads are all supported."),(0,o.kt)("h2",{id:"usage"},"Usage"),(0,o.kt)("h3",{id:"start-by-containers-ordinal"},"Start by containers ordinal"),(0,o.kt)("p",null,"It only requires you to add an annotation in Pod:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    apps.kruise.io/container-launch-priority: Ordered\nspec:\n  containers:\n  - name: sidecar\n    # ...\n  - name: main\n    # ...\n")),(0,o.kt)("p",null,"Then Kruise will ensure the former container (sidecar) to be started before the later one (main)."),(0,o.kt)("h3",{id:"start-by-configurable-sequence"},"Start by configurable sequence"),(0,o.kt)("p",null,"You should set the priority env ",(0,o.kt)("inlineCode",{parentName:"p"},"KRUISE_CONTAINER_PRIORITY")," in container:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nspec:\n  containers:\n  - name: main\n    # ...\n  - name: sidecar\n    env:\n    - name: KRUISE_CONTAINER_PRIORITY\n      value: "1"\n    # ...\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The range of the value is ",(0,o.kt)("inlineCode",{parentName:"li"},"[-2147483647, 2147483647]"),". Defaults to ",(0,o.kt)("inlineCode",{parentName:"li"},"0")," if no such env exists."),(0,o.kt)("li",{parentName:"ol"},"The container with higher priority will be guaranteed to start before the others with lower priority."),(0,o.kt)("li",{parentName:"ol"},"The containers with same priority have no limit to their start sequence.")),(0,o.kt)("h2",{id:"requirement"},"Requirement"),(0,o.kt)("p",null,"ContainerLaunchPriority requires ",(0,o.kt)("inlineCode",{parentName:"p"},"PodWebhook")," feature-gate to be enabled, which is the default state."),(0,o.kt)("h2",{id:"implementation-details"},"Implementation Details"),(0,o.kt)("p",null,"Kruise webhook will admit for all pod creation.\nWhen webhook finds a pod has ",(0,o.kt)("inlineCode",{parentName:"p"},"apps.kruise.io/container-launch-priority")," annotation or ",(0,o.kt)("inlineCode",{parentName:"p"},"KRUISE_CONTAINER_PRIORITY")," in env,\nit will inject ",(0,o.kt)("inlineCode",{parentName:"p"},"KRUISE_CONTAINER_BARRIER")," env into containers."),(0,o.kt)("p",null,"The value of KRUISE_CONTAINER_BARRIER is from a ConfigMap named ",(0,o.kt)("inlineCode",{parentName:"p"},"{pod-name}-barrier"),", and the key is related to the priority of each container."),(0,o.kt)("p",null,"For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nspec:\n  containers:\n  - name: main\n    # ...\n    env:\n    - name: KRUISE_CONTAINER_BARRIER\n      valueFrom:\n        configMapKeyRef:\n          name: {pod-name}-barrier\n          key: "p_0"\n  - name: sidecar\n    env:\n    - name: KRUISE_CONTAINER_PRIORITY\n      value: "1"\n    - name: KRUISE_CONTAINER_BARRIER\n      valueFrom:\n        configMapKeyRef:\n          name: {pod-name}-barrier\n          key: "p_1"\n    # ...\n')),(0,o.kt)("p",null,"Kruise controller will create an empty ConfigMap for this pod, then add the keys into ConfigMap according to the priorities and containerStatuses of pod."),(0,o.kt)("p",null,"As the example before, controller will firstly add ",(0,o.kt)("inlineCode",{parentName:"p"},"p_1")," key into ConfigMap, waiting for sidecar container running and ready, and finally add ",(0,o.kt)("inlineCode",{parentName:"p"},"p_0")," into ConfigMap to let Kubelet start main container."),(0,o.kt)("p",null,"Besides, you may see ",(0,o.kt)("inlineCode",{parentName:"p"},"CreateContainerConfigError")," state when you use ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get")," during pod is starting with priority.\nIt is because Kubelet can't find some keys at that moment, and will be fine after all container in Pod started."))}m.isMDXComponent=!0}}]);